---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const posts = await getCollection("blog");

    return posts.map((post) => {
        // Extract the path from the URL in frontmatter
        const urlMatch = post.data.url.match(
            /\/(\d{4})\/(\d{2})\/(\d{2})\/([^/]+)\.html/,
        );
        const slug = urlMatch
            ? `${urlMatch[1]}/${urlMatch[2]}/${urlMatch[3]}/${urlMatch[4]}`
            : `blog/${post.slug}`;

        return {
            params: { slug },
            props: { post, slug },
        };
    });
}

const { post, slug } = Astro.props;
const { Content } = await post.render();
const date = post.data.date;

// Get plain text from post body for title if needed
const plainText = post.body
    .replace(/<[^>]*>/g, "")
    .replace(/\n+/g, " ")
    .trim();

// Use title if available, otherwise use first part of content
const displayTitle =
    post.data.title ||
    (plainText ? plainText.substring(0, 95) + "..." : "No content available");

// Process content to fix image paths
const processedContent = post.body.replace(
    /https:\/\/ericbrookfield\.com\/uploads\/(\d{4})\//g,
    "/blog-images/$1/",
);
---

<Layout title={displayTitle} ogImage={`/og/${slug}.png`}>
    <article class="blog-post">
        <div class="container">
            <header class="post-header">
                <a href="/" class="back-link">← Back to Home</a>
                <time class="post-date">
                    {
                        date.toLocaleDateString("en-US", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        })
                    }
                </time>
                <h1>{displayTitle}</h1>
            </header>
            <div class="post-content">
                <Content />
            </div>
            <footer class="post-footer">
                <a href="/archive"> View all posts → </a>
            </footer>
        </div>
    </article>
</Layout>

<style>
    .blog-post {
        padding: var(--spacing-xl) 0;
        min-height: 100vh;
    }

    .container {
        max-width: 800px;
    }

    .post-header {
        margin-bottom: var(--spacing-lg);
    }

    .back-link {
        display: inline-block;
        margin-bottom: var(--spacing-md);
        font-family: "Inter", sans-serif;
        font-size: 0.95rem;
        color: var(--color-primary);
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .back-link:hover {
        color: var(--color-primary-dark);
    }

    .post-date {
        display: block;
        font-family: "Inter", sans-serif;
        font-size: 0.95rem;
        color: var(--color-text-light);
        margin-bottom: var(--spacing-sm);
    }

    .post-header h1 {
        font-size: 2.5rem;
        line-height: 1.2;
        margin-bottom: var(--spacing-lg);
    }

    .post-content {
        font-size: 1.125rem;
        line-height: 1.8;
        margin-bottom: var(--spacing-xl);
    }

    :global(.post-content p) {
        margin-bottom: var(--spacing-md);
    }

    :global(.post-content h2) {
        font-size: 1.75rem;
        margin-top: var(--spacing-lg);
        margin-bottom: var(--spacing-sm);
    }

    :global(.post-content h3) {
        font-size: 1.5rem;
        margin-top: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
    }

    :global(.post-content ul),
    :global(.post-content ol) {
        margin-bottom: var(--spacing-md);
        padding-left: var(--spacing-md);
    }

    :global(.post-content li) {
        margin-bottom: var(--spacing-xs);
    }

    :global(.post-content blockquote) {
        border-left: 4px solid var(--color-primary);
        padding-left: var(--spacing-md);
        margin: var(--spacing-md) 0;
        font-style: italic;
        color: var(--color-text-light);
    }

    :global(.post-content code) {
        font-family: "Courier New", monospace;
        background: var(--color-surface);
        padding: 0.2em 0.4em;
        font-size: 0.9em;
    }

    :global(.post-content pre) {
        background: var(--color-surface);
        padding: var(--spacing-md);
        overflow-x: auto;
        margin: var(--spacing-md) 0;
    }

    :global(.post-content pre code) {
        background: none;
        padding: 0;
    }

    :global(.post-content a) {
        color: var(--color-primary);
        text-decoration: underline;
    }

    :global(.post-content a:hover) {
        color: var(--color-primary-dark);
    }

    :global(.post-content img) {
        max-width: 100%;
        height: auto;
        margin: var(--spacing-md) 0;
        display: block;
    }

    :global(.post-content hr) {
        border: none;
        height: 1px;
        background: linear-gradient(
            90deg,
            transparent,
            var(--color-secondary) 20%,
            var(--color-primary) 50%,
            var(--color-secondary) 80%,
            transparent
        );
        margin: var(--spacing-lg) 0;
        opacity: 0.6;
    }

    :global([data-theme="light"] .post-content hr) {
        opacity: 0.4;
    }

    .post-footer {
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--color-border);
        text-align: center;
    }

    .post-footer a {
        font-size: 1.05rem;
        color: var(--color-primary);
        text-decoration: none;
    }

    .post-footer a:hover {
        color: var(--color-primary-dark);
    }

    @media (max-width: 768px) {
        .post-header h1 {
            font-size: 2rem;
        }

        .post-content {
            font-size: 1.05rem;
        }
    }
</style>
